/*
 * Copyright (c) 2020 Yahweasel
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
 * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
 * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
 * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */
var mkvdemuxjs=function(f){function g(){this.queue=[];this.pos=this.peekLo=this.peekHi=0;this.context=[];this.block=null;this.ex={}}function h(a,b,c,d){this.id=a;this.length=b;this.start=c;this.bodyStart=d;this.end=0<=b?d+b:Infinity;this.ex={}}g.prototype={push:function(a){this.queue.push(a)},peek:function(a){if(this.queue.length<=this.peekHi)return null;var b=this.queue[this.peekHi];if(0===this.peekLo&&b.byteLength>=a)return this.peekLo+=a,this.peekLo>=b.byteLength&&(this.peekHi++,this.peekLo=0),
b;if(b.byteLength>=this.peekLo+a){var c=(new Uint8Array(b)).slice(this.peekLo,this.peekLo+a);this.peekLo+=a;this.peekLo>=b.byteLength&&(this.peekHi++,this.peekLo=0);return c.buffer}c=new Uint8Array(a);c.set((new Uint8Array(b)).slice(this.peekLo));b=b.byteLength-this.peekLo;a-=b;for(var d=this.peekHi+1;a;){if(d>=this.queue.length)return null;var e=new Uint8Array(this.queue[d++]);e.length>=a?(e.length===a?(c.set(e,b),this.peekHi=d+1,this.peekLo=0):(c.set(e.slice(0,a),b),this.peekHi=d,this.peekLo=a),
a=0):(c.set(e,b),a-=e.length,b+=e.length)}return c.buffer},commit:function(){for(;this.peekHi;)this.pos+=this.queue[0].byteLength,this.queue.shift(),this.peekHi--;if(this.peekLo){this.pos+=this.peekLo;var a=(new Uint8Array(this.queue[0])).slice(this.peekLo);0===a.length?this.queue.shift():this.queue[0]=a.buffer;this.peekLo=0}for(;this.context.length&&this.context[this.context.length-1].end<=this.pos;)this.context.pop();this.block=this.context.length?this.context[this.context.length-1]:null},savePeek:function(){return{hi:this.peekHi,
lo:this.peekLo}},restorePeek:function(a){this.peekHi=a.hi;this.peekLo=a.lo},peekVint:function(a){var b=this.savePeek(),c=this.peek(1);if(null===c)return null;for(var c=(new Uint8Array(c))[0],d=1;!(c&128);)d++,c=c<<1&255;c=(c&127)>>>d-1;this.restorePeek(b);b=this.peek(d);if(null===b)return null;b=(new Uint8Array(b)).slice(0,d);a||(b[0]=c);for(c=a=0;c<b.length;c++)a*=256,a+=b[c];return a},readEBMLHeader:function(){var a=this.savePeek(),b=this.pos,c=this.peekVint(!0);if(null===c)return null;var d;d=
this.savePeek();var e=this.peek(1);if(null===e)return this.restorePeek(a),null;e=(new Uint8Array(e))[0];if(191===e)d=-1;else if(this.restorePeek(d),d=this.peekVint(),null===d)return this.restorePeek(a),null;this.commit();a=new h(c,d,b,this.pos);0<=d&&(this.context.push(a),this.block=a);return a},readEBMLBody:function(){if(0===this.block.length)return this.context.pop(),this.block=this.context.length?this.context[this.context.length-1]:null,null;var a=this.peek(this.block.end-this.pos);if(null===a)return null;
this.commit();return a},readUInt:function(){var a=this.block.length,b=this.readEBMLBody();if(0===a)return 0;if(null===b)return null;b=new DataView(b);switch(a){case 1:return b.getUint8(0);case 2:return b.getUint16(0);case 4:return b.getUint32(0);default:for(var c=0,b=new Uint8Array(b.buffer),d=0;d<a;d++)c*=256,c+=b[d];return c}},readFloat:function(){var a=this.block.length,b=this.readEBMLBody();if(0===a)return 0;if(null===b)return null;b=new DataView(b);return 4===a?b.getFloat32(0):8===a?b.getFloat64(0):
0},demux:function(){for(var a;;){this.context.length||this.readEBMLHeader();if(!this.context.length)return null;a=this.block;switch(a.id){case 440786851:case 290298740:case 357149030:case 307544935:case 30114:case 236:case 191:var b=this.readEBMLBody();if(null===b)return null;a.ex.content=b;return a;case 408125543:case 374648427:case 524531317:case 160:if(null===this.readEBMLHeader())return null;this.ex={};break;case 174:return this.readTrackEntry();case 231:a=this.readUInt();if(null===a)return null;
this.ex.clusterTimestamp=a;break;case 161:case 163:return this.decodeBlock();default:b=this.readEBMLBody();if(null===b)return null;console.log("Unrecognized element "+a.id.toString(16)+" at "+a.start.toString(16)+" to "+a.end.toString(16));console.log("Context:");for(var c=0;c<this.context.length;c++)console.log("  "+this.context[c].id.toString(16));a.ex.content=b;return a}}},readTrackEntry:function(){var a=this.block,b=a.end-this.pos,c=this.savePeek();if(null===this.peek(b))return null;this.restorePeek(c);
for(b={track:{}};this.block===a;){c=this.readEBMLHeader();if(null===c)return null;switch(c.id){case 156:case 2274716:case 22203:case 25506:this.readEBMLBody();break;case 225:this.context.pop();this.block=a;break;case 215:b.track.number=this.readUInt();break;case 29637:b.track.uid=this.readUInt();break;case 134:b.track.codec=this.readUInt();break;case 22186:b.track.codecDelay=this.readUInt()/1E9;break;case 131:c="unknown";switch(b.track.codecType=this.readUInt()){case 1:c="video";break;case 2:c="audio"}b.track.type=
c;break;case 159:b.track.channels=this.readUInt();break;case 181:b.track.sampleRate=this.readFloat();break;case 25188:b.track.bitDepth=this.readUInt();break;default:console.log("Unrecognized track entry component "+c.id.toString(16)),this.readEBMLBody()}}return b},decodeBlock:function(){var a=this.block.length,b=this.readEBMLBody();if(null===b)return null;var b=new DataView(b),c={},d=this.ex.clusterTimestamp;d||(d=0);var e=b.getUint8(0);e&128||console.log("ERROR: Track #s greater than 127 are not supported!");
var e=e&127,f=b.getInt16(1),d=(d+f)/1E3;0!==(b.getUint8(3)&6)&&console.log("ERROR: Lacing is not supported!");a={data:(new Uint8Array(b.buffer)).slice(4,a).buffer,track:e,timestamp:d};c.frames=[a];return c}};f.MkvDemux=g;return f}(mkvdemuxjs||{});"undefined"!==typeof module&&(module.exports=mkvdemuxjs);
